<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Treasure Hunt Game</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">
    </head>

    <style>
        body {
            font-family: "Pirata One", cursive;
            background-color: #f0f0f0;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
        }

        h1 {
            font-size: 36pt;
            text-align: center;
            margin: 10px 0;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 80%;
            max-width: 1200px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .game-board {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-board table {
            border-collapse: collapse;
        }

        .game-board td {
            width: 50px;
            height: 50px;
            border: 1px solid #000;
            background-color: #fff;
            text-align: center;
            vertical-align: middle;
            font-size: 1.5em;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .game-info, .chat-box {
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }

        .game-info h2, .chat-box h2 {
            margin-top: 0;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        #chat-input {
            width: calc(100% - 80px);
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .chat-box button, .game-controls button, .leave_game button {
            padding: 10px;
            font-size: 1em;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .chat-box button:hover, .game-controls button:hover, .leave_game button:hover {
            background-color: #0056b3;
        }

        .leave_game {
            text-align: center;
            margin-top: 10px;
        }

        .leave_game button {
            background-color: #FF0000;
        }

        .leave_game button:hover {
            background-color: #cc0000;
        }
    </style>

    <body>
        <h1>Treasure Hunt Game</h1>
        <div class="container">
            <div class="left-panel">
                <div class="game-board">
                    <table>
                        <tbody>
                            <!--JS Will Populate a table here-->
                        </tbody>
                    </table>
                </div>
                <div class="game-controls">
                    <button onclick="up()">⬆️</button>
                    <button onclick="down()">⬇️</button>
                    <button onclick="left()">⬅️</button>
                    <button onclick="right()">➡️</button>
                    <button onclick="DiagUpLeft()">↖️</button>
                    <button onclick="DiagUpRight()">↗️</button>
                    <button onclick="DiagDownLeft()">↙️</button>
                    <button onclick="DiagDownRight()">↘️</button>
                </div>
            </div>
            <div class="right-panel">
                <div class="game-info">
                    <h2>Game Info</h2>
                    <p>Players: </p> <!--JS will add and remove from this list dynamically-->
                    <p>Turn: </p> <!--JS will change this dynamically based on order of players-->
                    <p>Winner: </p> <!--JS will change this dynamically when a player wins-->
                </div>
                <div class="chat-box">
                    <h2>Chat Box</h2>
                    <div class="chat-messages">
                        <!--JS Will Populate Chat Messages Here-->
                    </div>
                    <input type="text" id="chat-input" placeholder="Enter your message here">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
        <div class="leave_game">
            <button onclick="leaveGame()">Leave Game</button>
        </div>
    </body>

    <script>
        // Variables to track player position and game state
        let currentPlayerPosition = { row: 0, col: 0 }; // Example starting position
        let currentTurn = null;
        let players = [];
        let gameOver = false;
        let ws;

        // Function to set up the board and initialize player position
        function setupGame() {
            document.addEventListener("DOMContentLoaded", function() {
                const tbody = document.querySelector(".game-board tbody");
    
                for (let row = 0; row < 10; row++) {
                    const tr = document.createElement("tr");
                    for (let col = 0; col < 10; col++) {
                        const td = document.createElement("td");
                        td.className = (row + col) % 2 === 0 ? "even" : "odd";
                        td.id = `cell-${row}-${col}`;
                        td.onclick = () => handleCellClick(row, col);
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                }
    
                // Initial player position
                updatePlayerPosition(currentPlayerPosition.row, currentPlayerPosition.col);

                // Initialize WebSocket connection
                ws = new WebSocket(`ws://${window.location.hostname}:3003`);
                ws.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    handleServerMessage(message);
                };
            });
        }

        // Function to handle messages from the server
        function handleServerMessage(message) {
            if (message.action === "state_update") {
                updateGameState(message.state);
            } else if (message.action === "chat") {
                displayChatMessage(message.player_name, message.message);
            }
        }

        // Function to update the game state
        function updateGameState(state) {
            players = state.players;
            currentTurn = state.current_turn;
            gameOver = state.game_over;

            // Update player positions on the board
            players.forEach(player => {
                const { name, position } = player;
                const cell = document.getElementById(`cell-${position.row}-${position.col}`);
                if (cell) {
                    cell.textContent = name.charAt(0); // Display the first letter of the player's name
                }
            });

            // Update game info
            document.querySelector(".game-info p:nth-child(2)").textContent = `Players: ${players.map(p => p.name).join(", ")}`;
            document.querySelector(".game-info p:nth-child(3)").textContent = `Turn: ${currentTurn}`;
            document.querySelector(".game-info p:nth-child(4)").textContent = `Winner: ${state.winner || "None"}`;
        }

        // Function to display chat messages
        function displayChatMessage(player_name, message) {
            const chatMessages = document.querySelector(".chat-messages");
            const messageElement = document.createElement("p");
            messageElement.textContent = `${player_name}: ${message}`;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Function to update the player position on the board
        function updatePlayerPosition(newRow, newCol) {
            // Clear previous position
            const prevCell = document.getElementById(`cell-${currentPlayerPosition.row}-${currentPlayerPosition.col}`);
            if (prevCell) prevCell.style.backgroundColor = "#fff";
    
            // Update position
            currentPlayerPosition = { row: newRow, col: newCol };
    
            // Set new position
            const newCell = document.getElementById(`cell-${newRow}-${newCol}`);
            if (newCell) newCell.style.backgroundColor = "#00f"; // Player color
        }
    
        // Functions to handle directional moves
        function up() { movePlayer(-1, 0); }
        function down() { movePlayer(1, 0); }
        function left() { movePlayer(0, -1); }
        function right() { movePlayer(0, 1); }
        function DiagUpLeft() { movePlayer(-1, -1); }
        function DiagUpRight() { movePlayer(-1, 1); }
        function DiagDownLeft() { movePlayer(1, -1); }
        function DiagDownRight() { movePlayer(1, 1); }
    
        // Move player function
        function movePlayer(rowChange, colChange) {
            if (gameOver) return;
    
            const newRow = currentPlayerPosition.row + rowChange;
            const newCol = currentPlayerPosition.col + colChange;
    
            // Boundary check
            if (newRow < 0 || newRow >= 10 || newCol < 0 || newCol >= 10) return;
    
            // Check if the new cell is occupied
            const newCell = document.getElementById(`cell-${newRow}-${newCol}`);
            if (newCell && !newCell.classList.contains("occupied")) {
                updatePlayerPosition(newRow, newCol);
    
                // Mark cell as occupied
                newCell.classList.add("occupied");
    
                // Send move to server
                sendMove(newRow, newCol);
            }
        }
    
        // Handle cell click
        function handleCellClick(row, col) {
            console.log(`Clicked on cell: ${row}, ${col}`);
        }
    
        // Chat functionality
        function sendMessage() {
            const input = document.getElementById("chat-input");
            const message = input.value;
            if (message) {
                displayChatMessage("You", message);
    
                // Send message to server
                sendChatMessage(message);
    
                input.value = "";
            }
        }
    
        function sendChatMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const chatMessage = {
                    action: "chat",
                    player_name: "You", // Replace with actual player name
                    message: message
                };
                ws.send(JSON.stringify(chatMessage));
            }
        }
    
        // Send move to server
        function sendMove(row, col) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const moveMessage = {
                    action: "move",
                    player_name: "You", // Replace with actual player name
                    position: { row, col }
                };
                ws.send(JSON.stringify(moveMessage));
            }
        }
    
        // Function to handle leaving the game
        function leaveGame() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const leaveMessage = {
                    action: "leave_game",
                    player_name: "You" // Replace with actual player name
                };
                ws.send(JSON.stringify(leaveMessage));
            }
            console.log("Player is leaving the game");
            alert("You have left the game.");
            window.location.reload(); // Refresh the page or redirect as needed
        }
    
        // Initialize game
        setupGame();
    </script>    
</html>